# Keystatic & Astro Integration Guide

## Introduction

This guide will help you integrate [Keystatic](https://keystatic.com/), an open-source headless CMS, with your Astro project, allowing you to manage and sync your content with GitHub.

## Prerequisites

1. **Existing Astro Project**: Ensure your project has server-side rendering (SSR) with `output: 'hybrid'` or `output: 'server'` configured.
2. **GitHub Account**: If you plan to sync data with GitHub, ensure you have a GitHub account with write permissions for the project repository.

## Installation Steps

### 1. Starting a New Project

If you're starting fresh, use the Keystatic CLI to set up a new Astro project:

<PackageManagerTabs>
  <Fragment slot="npm">
  ```shell
  npm create @keystatic@latest
  ```
  </Fragment>
  <Fragment slot="pnpm">
  ```shell
  pnpm create @keystatic@latest
  ```
  </Fragment>
  <Fragment slot="yarn">
  ```shell
  yarn create @keystatic
  ```
  </Fragment>
</PackageManagerTabs>

Choose the Astro template to get started quickly.

### 2. Installing Dependencies

Add the necessary integrations for Markdoc and React:

<PackageManagerTabs>
  <Fragment slot="npm">
  ```shell
  npx astro add react markdoc
  ```
  </Fragment>
  <Fragment slot="pnpm">
  ```shell
  pnpm astro add react markdoc
  ```
  </Fragment>
  <Fragment slot="yarn">
  ```shell
  yarn astro add react markdoc
  ```
  </Fragment>
</PackageManagerTabs>

Then, install Keystatic packages:

<PackageManagerTabs>
  <Fragment slot="npm">
  ```shell
  npm install @keystatic/core @keystatic/astro
  ```
  </Fragment>
  <Fragment slot="pnpm">
  ```shell
  pnpm add @keystatic/core @keystatic/astro
  ```
  </Fragment>
  <Fragment slot="yarn">
  ```shell
  yarn add @keystatic/core @keystatic/astro
  ```
  </Fragment>
</PackageManagerTabs>

### 3. Adding Keystatic Integration

Include the Keystatic integration in your Astro config file:

```js
// astro.config.mjs
import { defineConfig } from 'astro/config';
import react from '@astrojs/react';
import markdoc from '@astrojs/markdoc';
import keystatic from '@keystatic/astro';

export default defineConfig({
  integrations: [react(), markdoc(), keystatic()],
  output: 'hybrid',
});
```

### 4. Creating a Keystatic Config File

Define your content schema in `keystatic.config.ts`:

```ts
// keystatic.config.ts
import { config, fields, collection } from '@keystatic/core';

export default config({
  storage: {
    kind: 'local',
  },
  collections: {
    posts: collection({
      label: 'Posts',
      slugField: 'title',
      path: 'src/content/posts/*',
      format: { contentField: 'content' },
      schema: {
        title: fields.slug({ name: { label: 'Title' } }),
        content: fields.markdoc({
          label: 'Content',
        }),
      },
    }),
  },
});
```

### 5. Running Keystatic Locally

Start your development server:

```bash
npm run dev
```

Visit `http://127.0.0.1:4321/keystatic` to access the Keystatic Admin UI.

### 6. Creating a New Post

Use the Keystatic Admin UI to create a new post. This will generate a `.mdoc` file in your `src/content/posts` directory.

### 7. Rendering Keystatic Content

#### Displaying a Collection List

```tsx
---
import { getCollection } from 'astro:content';

const posts = await getCollection('posts');
---
<ul>
  {posts.map(post => (
    <li>
      <a href={`/posts/${post.slug}`}>{post.data.title}</a>
    </li>
  ))}
</ul>
```

#### Displaying a Single Entry

```tsx
---
import { getEntry } from 'astro:content';

const post = await getEntry('posts', 'my-first-post');
const { Content } = await post.render();
---
<main>
  <h1>{post.data.title}</h1>
  <Content />
</main>
```

## Deployment

Follow Astro's [deployment guides](https://astro.build/guides/deploy/) to deploy your project. Connect Keystatic to GitHub for content management on your deployed instance.

## Official Resources

- [Keystatic Documentation](https://keystatic.com/docs/installation-astro)
- [Keystatic Starter Template](https://github.com/Thinkmill/keystatic/tree/main/templates/astro)
